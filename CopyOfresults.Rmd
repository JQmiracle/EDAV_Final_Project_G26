# Results


## Bar Chart for All Machines to identify the top 2 machines with the most defect items
```{r}
p1 <- dfn_variable%>%   
  group_by(WorkcenterDesc) %>% 
  tally()  %>% 
  ggplot(aes(x = fct_reorder(WorkcenterDesc, n, .desc = TRUE), y = n))+
  geom_bar(stat="identity")+
  labs(x = "WorkcenterDesc", y = "Freq", title = "Variables")

p2 <- dfn_attribute%>%   
  group_by(WorkcenterDesc) %>% 
  tally()  %>% 
  ggplot(aes(x = fct_reorder(WorkcenterDesc, n, .desc = TRUE), y = n))+
  geom_bar(stat="identity")+
  labs(x = "WorkcenterDesc", y = "Freq", title = "Attributes")


grid.arrange(p1, p2, ncol = 2)
```
Since there are thirteen machines in the factory, we are interested in checking if there is distribution difference of Exception data among them. Meaning that if there are some machines that have apparently more exceptions than the others. From the histograms above, we found that machine I4 and machine I7 are the two machines that have the most Exception frequency for both Variables and Attributes characteristics. So we will further study those machines in depth later. It also gives us a rough idea that there might be correlation between Variable and Attribute exception performances, which means if a machine has more Variable exception, it could have more Attribute exception potentially. We will study that later as well. 

## Group bar chart to identify the top attribute and varibales Among all machines
```{r}
p3<- dfn_attribute %>%   
  group_by(WorkcenterDesc, MIC_Desc) %>% 
  count(Result)%>% 
  group_by(WorkcenterDesc) %>% 
  mutate(Proportion = `n` / sum(n)) %>% 
  ggplot(aes(x = fct_reorder2(WorkcenterDesc, MIC_Desc, Proportion, .desc = FALSE), y = Proportion, fill = MIC_Desc))+
  geom_bar(position="fill", stat="identity")+
    labs(x = "WorkcenterDesc", y = "Proportion", title = "Top Attribute for each machine")+
    coord_flip()+
scale_fill_brewer(palette="Paired")


p4<-dfn_variable %>%   
  group_by(WorkcenterDesc, MIC_Desc) %>% 
  tally()%>% 
  group_by(WorkcenterDesc) %>% 
  mutate(Proportion = `n` / sum(n)) %>% 
  ggplot(aes(x = fct_reorder2(WorkcenterDesc, MIC_Desc, Proportion, .desc = TRUE), y = Proportion, fill = MIC_Desc))+
  geom_bar(position="fill", stat="identity")+
    labs(x = "WorkcenterDesc", y = "Proportion", title = "Top Variables for each machine")+
    coord_flip()+
scale_fill_brewer(palette="Paired")

p3
p4
```
In a general review of Attribute and Variable date by machine, we found that for most machines, Visual Evaluation and Form are the major Attribute exceptions for most of the machines except for I1. They take up at least 60% of the Attributes exceptions. This is a good information for the company to assign attention and resources based on the category of defects. For example, in order to address the Visual Evaluation exceptions, it may be good to focus on the quality of raw materials used in production. 

Part Weight is the most significant Variable exception for all machines, with Silicone Ratio being the secondary. In the following sections, we will put Part Weight and Silicone Ratio as key focuses to study. 

## Parallel coordinate plot: count(partweight)  vs count(wall thickness)  vs count(silicone ratio)  + count(all) every line summary
```{r}
dfn_p_s <- dfn_variable %>%   
  filter(MIC_Desc == 'Part Weight' | MIC_Desc == 'Silicone Ratio' )

dfn_v_a <-
  rbind(dfn_p_s, dfn_attribute)

dfn_v_a %>%  
  group_by(WorkcenterDesc, MIC_Desc)%>%
  tally(sort = TRUE)  %>% pivot_wider(names_from = MIC_Desc, values_from = n)%>%   
  select(c('Part Weight', 'Silicone Ratio', 'Visual Evaluation', 'Form')) %>% 
  filter (`Silicone Ratio` != 'NA') %>%  
  ggparcoord(columns = c(3,2,4,5), alphaLines = 1,
             groupColumn = 1) +
  geom_vline(xintercept = 1:5, color = "lightblue")+
  ggtitle('dd')
```





## Ridgeline plot for part weight exception for each line: use weight difference = (result - target)/target.
```{r}
dfn_weight <- dplyr::filter(dfn_variable, MIC_Desc =="Part Weight")
dfn_weight <- within(dfn_weight, weight_diff <- (Result - Target)/Target )
p5 <- ggplot(dfn_weight, aes(x = weight_diff, y = WorkcenterDesc)) +
  geom_density_ridges(fill = "blue") +
  ggtitle("Part Weight Result") +
  ylab("Machine")

p5

```

## Multiple boxplots of Part Weight Result according to WorkcenterDesc Type
```{r}
p6 <- dfn_variable  %>% 
  filter(MIC_Desc == 'Part Weight') %>% 
  ggplot(aes(x=reorder(WorkcenterDesc, Result, median),y=Result)) +
  geom_boxplot() +
  coord_flip() +
  ggtitle("Multiple boxplots of Part Weight Result according to WorkcenterDesc Type") +
  labs(x="Part Weight", y="WorkcenterDesc Type")

p6
```











## Pick machine I4 and I7 to study because they have most exceptions.

### Study Machine I4

```{r}
dfn_attribute4 <- dplyr::filter(dfn_attribute, WorkcenterDesc=="I4") #filter by machine I4
dfn_variable4 <- dplyr::filter(dfn_variable, WorkcenterDesc=="I4") #filter by machine I4

p7 <- dfn_variable4%>%   
  group_by(MIC_Desc) %>% 
  tally()  %>% 
  ggplot(aes(x = fct_reorder(MIC_Desc, n, .desc = FALSE), y = n))+
  geom_bar(stat="identity")+
  labs(x = "MIC_Desc", y = "Freq", title = "Variables")+
  coord_flip()

p8 <- dfn_attribute4%>%   
  group_by(MIC_Desc) %>% 
  tally()  %>% 
  ggplot(aes(x = fct_reorder(MIC_Desc, n, .desc = FALSE), y = n))+
  geom_bar(stat="identity")+
  labs(x = "MIC_Desc", y = "Freq", title = "Attributes")+
  coord_flip()


grid.arrange(p7, p8, nrow = 2)
```


### Study Machine I7

```{r}
dfn_attribute7 <- dplyr::filter(dfn_attribute, WorkcenterDesc=="I7") #filter by machine I7
dfn_variable7 <- dplyr::filter(dfn_variable, WorkcenterDesc=="I7") #filter by machine I7

p9 <- dfn_variable7%>%   
  group_by(MIC_Desc) %>% 
  tally()  %>% 
  ggplot(aes(x = fct_reorder(MIC_Desc, n, .desc = FALSE), y = n))+
  geom_bar(stat="identity")+
  labs(x = "MIC_Desc", y = "Freq", title = "Variables")+
  coord_flip()

p10 <- dfn_attribute7%>%   
  group_by(MIC_Desc) %>% 
  tally()  %>% 
  ggplot(aes(x = fct_reorder(MIC_Desc, n, .desc = FALSE), y = n))+
  geom_bar(stat="identity")+
  labs(x = "MIC_Desc", y = "Freq", title = "Attributes")+
  coord_flip()


grid.arrange(p9, p10, nrow = 2)
```




### Time series plot of attribute exception throughout the 3 months. For I4 and I7 repectively.  (overall + by week) 

```{r}
var4_time <- dfn_variable4 %>%
  filter(MIC_Desc == 'Part Weight')%>%  
  mutate(Date = as.Date(PostingDate, "%m/%d/%Y"))%>%  
  mutate(ResultDiff = (Result - Target)/Target)%>%
  group_by(Date)%>%
  summarize(MeanRetDiff = mean(ResultDiff))


g <- ggplot(var4_time,aes(Date, MeanRetDiff)) +
  geom_line(alpha = 1) +
  ggtitle("Part Weight of I4") +  labs (x = "Date", y = "Result") +
  theme_grey(16) +
  theme(legend.title = element_blank())

weekend <- var4_time %>% filter(wday(Date) == 6) 

p11 <- g+geom_point(data = weekend, aes(Date, MeanRetDiff), color = "deeppink")

p11
```

```{r}
p12 <-ggplot(var4_time, aes(Date, MeanRetDiff)) +  
    geom_line(color = "grey30") + geom_point(size = 1) +  
    facet_grid(.~wday(Date, label = TRUE)) +  
    geom_smooth(se = FALSE)

p12

```






```{r}
var7_time <- dfn_variable7 %>%
  filter(MIC_Desc == 'Part Weight')%>%  
  mutate(Date = as.Date(PostingDate, "%m/%d/%Y"))%>%  
  mutate(ResultDiff = (Result - Target)/Target)%>%
  group_by(Date)%>%
  summarize(MeanRetDiff = mean(ResultDiff))


g <- ggplot(var7_time,aes(Date, MeanRetDiff)) +
  geom_line(alpha = 1) +
  ggtitle("Part Weight of I7") +  labs (x = "Date", y = "Result") +
  theme_grey(16) +
  theme(legend.title = element_blank())

weekend <- var7_time %>% filter(wday(Date) == 6 ) 

p13 <- g+geom_point(data = weekend, aes(Date, MeanRetDiff), color = "deeppink")
p13
```

```{r}
p14 <- ggplot(var7_time, aes(Date, MeanRetDiff)) +  
    geom_line(color = "grey30") + geom_point(size = 1) +  
    facet_grid(.~wday(Date, label = TRUE)) +  
    geom_smooth(se = FALSE)

p14
```


### Heatmap
```{r}
dfn_variable7 <- within(dfn_variable7, result_diff <- (Result - Target)/Target )
dfn_variable7 <- dplyr::filter(dfn_variable7, MIC_Desc!="Silicone Application Check")
dfn_variable7 <- dplyr::filter(dfn_variable7, Material_Code!="51800B75")
dfn_variable7w <- dplyr::filter(dfn_variable7, MIC_Desc=="Part Weight")

ggplot(dfn_variable7w, aes(MIC_Desc,Material_Code)) +
  geom_tile(aes(fill = result_diff)) +
  facet_wrap(~InspectionPlan)


dfn_variable4 <- within(dfn_variable4, result_diff <- (Result - Target)/Target )
dfn_variable4w <- dplyr::filter(dfn_variable4, MIC_Desc=="Part Weight")
ggplot(dfn_variable4w, aes(MIC_Desc,Material_Code)) +
  geom_tile(aes(fill = result_diff))+
  facet_wrap(~InspectionPlan)


ggplot(dfn_variable7, aes(MIC_Desc,Material_Code)) +
  geom_tile(aes(fill = result_diff))+
  scale_fill_viridis_c(direction=1)


ggplot(dfn_variable4, aes(MIC_Desc,Material_Code)) +
  geom_tile(aes(fill = result_diff))+
  scale_fill_viridis_c(direction=1)

```

### Scatter Plot

```{r}
dfn_variable <- within(dfn_variable, date <- as.Date(PostingDate,'%m/%d/%Y'))
dfn_variable <- within(dfn_variable, result_diff <- (Result - Target)/Target)
dfn_variable47 <- dplyr::filter(dfn_variable, WorkcenterDesc =="I4"|WorkcenterDesc =="I7")
tidy_dfn_variable <- pivot_wider(dfn_variable47, names_from = MIC_Desc, values_from = result_diff)[ , c("WorkcenterDesc","date","Part Weight","Silicone Ratio")]
colnames(tidy_dfn_variable)[3] ="weight"
colnames(tidy_dfn_variable)[4] ="silicone"

weight_silicone <- tidy_dfn_variable %>% 
  group_by(WorkcenterDesc,date) %>% 
  summarise(.,weight= mean(weight,na.rm= TRUE),
            silicone = mean(silicone,na.rm=TRUE))
weight_silicone <- within(weight_silicone, month <- months(date))
weight_silicone <- dplyr::filter(weight_silicone, month!="December")
ggplot(weight_silicone, aes(weight, silicone, color = month)) + 
  geom_point() +
  facet_wrap(~WorkcenterDesc)+
  labs(x = "Part Weight", y = "Silicone Ratio") +
  ggtitle("Machine I4 and I7 Scatter Plot by Part Weight and Silicone Ratio")

```


### Cleveland dot plot with multiple dots
```{r}
dfn_variable4 %>%
  filter(MIC_Desc == 'Part Weight')%>%  
  mutate(Date = as.Date(PostingDate, "%m/%d/%Y"))%>%  
  mutate(ResultDiff = (Result - Target)/Target)%>%
  mutate(month = months(Date))%>%
  filter(month != 'December')%>%
  group_by(Material_Desc, month)%>%
  summarize(MeanRetDiff = mean(ResultDiff))%>%
ggplot(aes(x = MeanRetDiff, y =   fct_reorder2(Material_Desc, month == 'September', MeanRetDiff,.desc=FALSE), color = month)) +

  geom_point()+
  ggtitle("by item") +
  ylab("") +
  theme_linedraw()
```



```{r}
dfn_variable7 %>%
  filter(MIC_Desc == 'Part Weight')%>%  
  mutate(Date = as.Date(PostingDate, "%m/%d/%Y"))%>%  
  mutate(ResultDiff = (Result - Target)/Target)%>%
  mutate(month = months(Date))%>%
  filter(month != 'December')%>%
  group_by(Material_Desc, month)%>%
  summarize(MeanRetDiff = mean(ResultDiff))%>%
ggplot(aes(x = MeanRetDiff, y =   fct_reorder2(Material_Desc, month == 'September', MeanRetDiff,.desc=FALSE), color = month)) +

  geom_point()+
  ggtitle("by item") +
  ylab("") +
  theme_linedraw()
```




